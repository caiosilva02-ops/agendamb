<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Firebase Aprimorada</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

<style>
body { font-family: 'Inter', sans-serif; margin: 20px; background:#f5f6fb; color:#222; }
h1 { color:#333; }
input, select, textarea, button { margin: 4px 0; padding: 8px 10px; font-size:14px; border-radius: 4px; border: 1px solid #ddd; }
button { cursor:pointer; background: #007bff; color: white; border: none; font-weight: bold; }
button:hover:not(:disabled) { background: #0056b3; }
button:disabled { background: #ccc; cursor: not-allowed; }
table { border-collapse: collapse; width: 100%; margin-top:10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background: white; }
th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
th { background: #f0f0f0; }
.delete-btn { background: #dc3545; padding: 4px 8px; font-size: 12px; }
.delete-btn:hover { background: #c82333; }

/* Layout dos pain√©is */
#dashboard {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    margin-bottom: 20px;
}
.panel {
    flex: 1;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
.event-item {
    padding: 5px 0;
    border-bottom: 1px dashed #eee;
    font-size: 14px;
}
.event-item:last-child {
    border-bottom: none;
}
.event-item strong {
    color: #007bff;
}

/* Estilos do Toast */
.toast {
  position: fixed; right: 15px; bottom: 15px;
  background: #333; color: #fff; padding: 10px 14px;
  border-radius: 8px; opacity: 0; transition: opacity 0.3s ease;
  z-index: 1000;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>

<h1>üìÖ Agenda de Eventos</h1>

<div>
  <button id="loginBtn">Login Google / Sair</button>
  <span id="userInfo">Carregando...</span>
</div>

<div id="dashboard">
    <div class="panel">
        <h3>√öltimos Criados</h3>
        <div id="latestEvents">Carregando...</div>
    </div>
    <div class="panel">
        <h3>Pr√≥ximos Eventos</h3>
        <div id="upcomingEvents">Carregando...</div>
    </div>
</div>

<h2>Novo Evento</h2>
<input id="title" placeholder="T√≠tulo" /><br>
<input type="date" id="date" /><br>

<div style="display:inline-block; margin: 4px 0;">
    <select id="timeHour" style="width: 80px;"></select> :
    <select id="timeMinute" style="width: 80px;"></select>
</div>
<br>

<input id="creator" placeholder="Criador" /><br>
<textarea id="desc" placeholder="Descri√ß√£o"></textarea><br>
<button id="save">Salvar evento</button>

<h2>Todos os Eventos</h2>
<table>
  <thead>
    <tr><th>T√≠tulo</th><th>Data</th><th>Hora</th><th>Criador</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr>
  </thead>
  <tbody id="eventsBody"><tr><td colspan="6">Carregando eventos...</td></tr></tbody>
</table>

<br>
<button id="pdfBtn">üìÑ Gerar PDF (Formato Tabela)</button>

<div id="toast" class="toast"></div>

<script>
// NOTA: Mantenha suas credenciais privadas.
const firebaseConfig = {
  apiKey: "AIzaSyAIdzJHTsvIpUaHszzX8q6jPfR3sh9IfOI",
  authDomain: "agendadigital-44dc9.firebaseapp.com",
  projectId: "agendadigital-44dc9",
  storageBucket: "agendadigital-44dc9.firebasestorage.app",
  messagingSenderId: "569121363405",
  appId: "1:569121363405:web:1c7ab280393c090c40a084"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elementos DOM
const loginBtn = document.getElementById('loginBtn');
const userInfo = document.getElementById('userInfo');
const toast = document.getElementById('toast');
const tbody = document.getElementById('eventsBody');
const titleI = document.getElementById('title');
const dateI = document.getElementById('date');
const timeHourI = document.getElementById('timeHour'); // Novo
const timeMinuteI = document.getElementById('timeMinute'); // Novo
const creatorI = document.getElementById('creator');
const descI = document.getElementById('desc');
const saveBtn = document.getElementById('save');
const latestEventsDiv = document.getElementById('latestEvents');
const upcomingEventsDiv = document.getElementById('upcomingEvents');


let currentUser = null;

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// üîπ Inicializa√ß√£o do Seletor de Horas/Minutos
function populateTimeSelectors() {
    for (let h = 0; h < 24; h++) {
        const hour = h.toString().padStart(2, '0');
        const option = new Option(hour, hour);
        timeHourI.appendChild(option);
    }
    for (let m = 0; m < 60; m += 5) { // Incremento de 5 minutos
        const minute = m.toString().padStart(2, '0');
        const option = new Option(minute, minute);
        timeMinuteI.appendChild(option);
    }
    // Define um valor padr√£o
    timeHourI.value = new Date().getHours().toString().padStart(2, '0');
    timeMinuteI.value = '00';
}
populateTimeSelectors();


// üîπ Mant√©m login persistente
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

// üîπ Detecta mudan√ßas de autentica√ß√£o
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    const name = user.isAnonymous ? 'Usu√°rio an√¥nimo' : (user.displayName || user.email);
    userInfo.textContent = `Logado como: ${name}`;
    loginBtn.textContent = user.isAnonymous ? 'Login Google' : 'Sair';
    if (!creatorI.value) creatorI.value = name;
  } else {
    try {
      await auth.signInAnonymously();
    } catch (err) {
      console.error(err);
      showToast("Erro ao autenticar anonimamente");
    }
  }
});

// üîπ Bot√£o de login / logout (Usando Pop-up, conforme corrigido)
loginBtn.addEventListener('click', async () => {
  if (currentUser && !currentUser.isAnonymous) {
    await auth.signOut();
    showToast("Deslogado com sucesso");
  } else {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');
    try {
      await auth.signInWithPopup(provider); // Corrigido para Popup
      showToast("Login Google realizado com sucesso!");
    } catch (e) {
      console.error(e);
      if (e.code !== 'auth/popup-closed-by-user') {
        showToast("Erro no login Google");
      }
    }
  }
});

/**
 * üîπ Fun√ß√£o para deletar um evento
 * @param {string} id - O ID do documento no Firestore
 */
async function deleteEvent(id) {
    if (!confirm("Tem certeza que deseja excluir este evento?")) {
        return;
    }
    try {
        await db.collection('events').doc(id).delete();
        showToast("Evento exclu√≠do!");
    } catch (err) {
        console.error("Erro ao excluir evento:", err);
        showToast("Erro ao excluir evento");
    }
}
window.deleteEvent = deleteEvent; 


// üîπ Salvar evento
saveBtn.addEventListener('click', async () => {
  const title = titleI.value.trim();
  const date = dateI.value;
  const time = `${timeHourI.value}:${timeMinuteI.value}`; // Combinando hora e minuto
  const creator = creatorI.value.trim();
  const desc = descI.value.trim();

  if (!title || !date) {
    showToast("T√≠tulo e data s√£o obrigat√≥rios");
    return;
  }
  
  saveBtn.disabled = true;

  try {
    await db.collection('events').add({
      title, date, time, creator, desc,
      createdBy: currentUser ? currentUser.uid : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showToast("Evento salvo!");
    
    // Limpeza completa do formul√°rio
    titleI.value = '';
    dateI.value = ''; 
    descI.value = '';
    // Manter a hora/minuto no valor padr√£o
    timeHourI.value = new Date().getHours().toString().padStart(2, '0');
    timeMinuteI.value = '00';

  } catch (err) {
    console.error(err);
    showToast("Erro ao salvar evento");
  } finally {
    saveBtn.disabled = false;
  }
});

/**
 * üîπ Renderiza a lista de eventos no painel (todos, pr√≥ximos, ou recentes)
 * @param {HTMLElement} targetDiv - O elemento DOM onde renderizar.
 * @param {Array} events - A lista de objetos de evento.
 * @param {string} type - Tipo de renderiza√ß√£o ('table', 'list').
 */
function renderEvents(targetDiv, events, type = 'table') {
    if (type === 'table') {
        tbody.innerHTML = '';
        if (events.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">Nenhum evento</td></tr>';
            return;
        }
        events.forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.title || ''}</td>
                <td>${e.date || ''}</td>
                <td>${e.time || ''}</td>
                <td>${e.creator || ''}</td>
                <td>${e.desc || ''}</td>
                <td>
                    <button class="delete-btn" onclick="deleteEvent('${e.id}')">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } else if (type === 'list') {
        targetDiv.innerHTML = '';
        if (events.length === 0) {
             targetDiv.innerHTML = '<p style="margin: 0; font-size:12px;">Nenhum evento encontrado.</p>';
             return;
        }
        events.forEach(e => {
            const div = document.createElement('div');
            div.className = 'event-item';
            div.innerHTML = `
                <strong>${e.date} ${e.time}</strong>: ${e.title} (Criador: ${e.creator})
            `;
            targetDiv.appendChild(div);
        });
    }
}

// üîπ Listener em tempo real para todos os eventos
db.collection('events')
  .orderBy('date','asc') 
  .orderBy('time','asc')
  .onSnapshot(snapshot => {
    let allEvents = [];
    if (!snapshot.empty) {
        snapshot.forEach(doc => {
            allEvents.push({ id: doc.id, ...doc.data() });
        });
    }

    // 1. Renderiza a tabela principal (ordenada por proximidade)
    renderEvents(tbody, allEvents, 'table');

    // 2. Renderiza os Pain√©is
    updateDashboards(allEvents);

  }, error => {
    console.error("Erro ao receber eventos:", error);
    showToast("Erro ao carregar a lista de eventos.");
  });

/**
 * üîπ Atualiza os pain√©is "Pr√≥ximos Eventos" e "√öltimos Criados"
 * @param {Array} allEvents - Lista completa de eventos.
 */
function updateDashboards(allEvents) {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    
    // --- Pr√≥ximos Eventos (Filtra eventos futuros, ordena por proximidade)
    const upcomingEvents = allEvents
        .filter(e => {
            // Cria uma string de data/hora completa para compara√ß√£o
            const eventDateTime = new Date(`${e.date}T${e.time}`);
            return eventDateTime >= now;
        })
        .slice(0, 5); // Limita aos 5 pr√≥ximos

    renderEvents(upcomingEventsDiv, upcomingEvents, 'list');

    // --- √öltimos Criados (Ordena por 'createdAt' - Timestamp do servidor)
    // Para obter os "√öltimos Criados", fazemos uma nova query, ordenando por createdAt
    db.collection('events')
        .orderBy('createdAt', 'desc')
        .limit(5)
        .get()
        .then(snapshot => {
            let latest = [];
            snapshot.forEach(doc => {
                latest.push({ id: doc.id, ...doc.data() });
            });
            renderEvents(latestEventsDiv, latest, 'list');
        })
        .catch(err => {
            console.error("Erro ao carregar eventos recentes:", err);
            latestEventsDiv.innerHTML = 'Erro ao carregar recentes.';
        });
}


// üîπ Gerar PDF com todos os eventos em formato de tabela
document.getElementById('pdfBtn').addEventListener('click', () => {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Dados da Tabela
        const head = [['T√≠tulo', 'Data', 'Hora', 'Criador', 'Descri√ß√£o']];
        const rows = [];
        
        // Pega os dados da tabela principal para garantir que est√£o atualizados
        const eventRows = document.querySelectorAll('#eventsBody tr');
        
        eventRows.forEach(row => {
            // Filtra linhas que n√£o s√£o a mensagem de 'Nenhum evento' e que t√™m 6 c√©lulas (5 + A√ß√µes)
            if (row.children.length === 6) { 
                const cells = row.querySelectorAll('td');
                // Adiciona apenas as 5 primeiras c√©lulas (sem a coluna A√ß√µes)
                rows.push([
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent,
                    cells[4].textContent
                ]);
            }
        });

        if (rows.length === 0) {
            showToast("Nenhum evento para gerar PDF");
            return;
        }

        // T√≠tulo
        doc.setFontSize(18);
        doc.text('Agenda de Eventos (Formato Tabela)', 10, 15);
        
        // Gera√ß√£o da Tabela usando jspdf-autotable
        doc.autoTable({
            startY: 25,
            head: head,
            body: rows,
            theme: 'striped',
            headStyles: { fillColor: [0, 123, 255] }, // Azul
            styles: { fontSize: 10, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 35 }, // T√≠tulo
                1: { cellWidth: 20 }, // Data
                2: { cellWidth: 15 }, // Hora
                3: { cellWidth: 25 }, // Criador
                4: { cellWidth: 'auto' } // Descri√ß√£o
            }
        });


        doc.save('agenda_tabela.pdf');
        showToast("PDF gerado!");
    } catch (err) {
        console.error("Erro ao gerar PDF:", err);
        showToast("Erro ao gerar PDF");
    }
});

</script>
</body>
</html>
