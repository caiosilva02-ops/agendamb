<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Firebase</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: 'Inter', sans-serif; margin: 20px; background:#f5f6fb; color:#222; }
h1 { color:#333; }
input, textarea, button { margin: 4px 0; padding: 6px; font-size:14px; }
button { cursor:pointer; }
table { border-collapse: collapse; width: 100%; margin-top:10px; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background: #f0f0f0; }
.toast {
  position: fixed; right: 15px; bottom: 15px;
  background: #333; color: #fff; padding: 10px 14px;
  border-radius: 8px; opacity: 0; transition: opacity 0.3s ease;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>

<h1>📅 Agenda de Eventos</h1>

<div>
  <button id="loginBtn">Login Google / Sair</button>
  <span id="userInfo">Carregando...</span>
</div>

<h2>Novo Evento</h2>
<input id="title" placeholder="Título" /><br>
<input type="date" id="date" /><br>
<input type="time" id="time" /><br>
<input id="creator" placeholder="Criador" /><br>
<textarea id="desc" placeholder="Descrição"></textarea><br>
<button id="save">Salvar evento</button>

<h2>Eventos</h2>
<table>
  <thead>
    <tr><th>Título</th><th>Data</th><th>Hora</th><th>Criador</th><th>Descrição</th></tr>
  </thead>
  <tbody id="eventsBody"><tr><td colspan="5">Carregando eventos...</td></tr></tbody>
</table>

<br>
<button id="pdfBtn">📄 Gerar PDF</button>

<div id="toast" class="toast"></div>

<script>
const firebaseConfig = {
  // ⚠️ Substitua pelos dados do seu projeto Firebase
  apiKey: "AIzaSyAIdzJHTsvIpUaHszzX8q6jPfR3sh9IfOI",
  authDomain: "agendadigital-44dc9.firebaseapp.com",
  projectId: "agendadigital-44dc9",
  storageBucket: "agendadigital-44dc9.firebasestorage.app",
  messagingSenderId: "569121363405",
  appId: "1:569121363405:web:1c7ab280393c090c40a084"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('loginBtn');
const userInfo = document.getElementById('userInfo');
const toast = document.getElementById('toast');
const tbody = document.getElementById('eventsBody');
const titleI = document.getElementById('title');
const dateI = document.getElementById('date');
const timeI = document.getElementById('time');
const creatorI = document.getElementById('creator');
const descI = document.getElementById('desc');

let currentUser = null;

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// 🔹 Trata o retorno do login via redirect (Google)
auth.getRedirectResult().then(result => {
  if (result.user) {
    showToast("Login Google bem-sucedido!");
  }
}).catch(err => {
  console.error(err);
  showToast("Erro ao concluir login Google");
});

// 🔹 Mantém login persistente
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

// 🔹 Detecta mudanças de autenticação
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    const name = user.isAnonymous ? 'Usuário anônimo' : (user.displayName || user.email);
    userInfo.textContent = `Logado como: ${name}`;
    loginBtn.textContent = user.isAnonymous ? 'Login Google' : 'Sair';
    if (!creatorI.value) creatorI.value = name;
  } else {
    try {
      await auth.signInAnonymously();
    } catch (err) {
      console.error(err);
      showToast("Erro ao autenticar anonimamente");
    }
  }
});

// 🔹 Botão de login / logout
loginBtn.addEventListener('click', async () => {
  if (currentUser && !currentUser.isAnonymous) {
    await auth.signOut();
    showToast("Deslogado com sucesso");
  } else {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');
    try {
      await auth.signInWithRedirect(provider);
    } catch (e) {
      console.error(e);
      showToast("Erro no login Google");
    }
  }
});

// 🔹 Salvar evento
document.getElementById('save').addEventListener('click', async () => {
  const title = titleI.value.trim();
  const date = dateI.value;
  const time = timeI.value;
  const creator = creatorI.value.trim();
  const desc = descI.value.trim();

  if (!title || !date) {
    showToast("Título e data são obrigatórios");
    return;
  }

  try {
    await db.collection('events').add({
      title, date, time, creator, desc,
      createdBy: currentUser ? currentUser.uid : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showToast("Evento salvo!");
    titleI.value = '';
    descI.value = '';
  } catch (err) {
    console.error(err);
    showToast("Erro ao salvar evento");
  }
});

// 🔹 Listener em tempo real para eventos
db.collection('events')
  .orderBy('date', 'desc')
  .orderBy('time', 'desc')
  .onSnapshot(snapshot => {
    tbody.innerHTML = '';
    if (snapshot.empty) {
      tbody.innerHTML = '<tr><td colspan="5">Nenhum evento</td></tr>';
      return;
    }
    snapshot.forEach(doc => {
      const e = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.title || ''}</td>
        <td>${e.date || ''}</td>
        <td>${e.time || ''}</td>
        <td>${e.creator || ''}</td>
        <td>${e.desc || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  });

// 🔹 Gerar PDF com todos os eventos
document.getElementById('pdfBtn').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 10;

  doc.setFontSize(16);
  doc.text('Agenda de Eventos', 10, y);
  y += 10;
  doc.setFontSize(12);

  const snapshot = await db.collection('events').orderBy('date','asc').orderBy('time','asc').get();
  snapshot.forEach(d => {
    const e = d.data();
    doc.text(`Título: ${e.title}`, 10, y); y += 6;
    doc.text(`Data: ${e.date} Hora: ${e.time || ''}`, 10, y); y += 6;
    doc.text(`Criador: ${e.creator}`, 10, y); y += 6;
    doc.text(`Descrição: ${e.desc}`, 10, y); y += 8;
    if (y > 270) { doc.addPage(); y = 10; }
  });

  doc.save('agenda.pdf');
  showToast("PDF gerado!");
});
</script>
</body>
</html>

