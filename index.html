<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Virtual - Milton Borges Ypiranga - Gest칚o</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<!-- FullCalendar (Calend치rio estilo Google) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* === VARI츼VEIS E BASE === */
:root {
    --primary-color: #3f51b5;
    --secondary-color: #00bcd4;
    --background-light: #f4f7f6;
    --background-dark: #2c3e50;
    --surface-light: #ffffff;
    --border-color: #e0e0e0;
    --text-dark: #333333;
    --text-light: #ffffff;
    --text-muted: #7f8c8d;
    --shadow-subtle: 0 4px 8px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 8px 16px rgba(0, 0, 0, 0.15);
    --success-color: #28a745;
    --danger-color: #dc3545;
}

body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 30px;
    background: var(--background-light);
    color: var(--text-dark);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

h1 {
    color: var(--primary-color);
    font-weight: 700;
    font-size: 2.4em;
    text-align: center;
    border-bottom: 3px solid var(--secondary-color);
    padding-bottom: 10px;
}

/* === CALEND츼RIO === */
#calendar {
    background: var(--surface-light);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    box-shadow: var(--shadow-subtle);
    padding: 20px;
    margin-top: 30px;
}
.fc-toolbar-title {
    color: var(--primary-color);
    font-weight: 600;
}
.fc-event {
    background-color: var(--secondary-color);
    border: none;
    color: white;
    font-size: 0.9em;
}

/* === FORM, DASHBOARD, BOT칏ES (mantidos) === */
.form-section, .panel {
    background: var(--surface-light);
    padding: 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-subtle);
    border: 1px solid var(--border-color);
    margin-bottom: 30px;
}

button {
    cursor: pointer;
    background: var(--primary-color);
    color: var(--text-light);
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 500;
}
button:hover { background: var(--secondary-color); }

/* === TOAST === */
.toast {
    position: fixed; right: 20px; bottom: 20px;
    background: var(--background-dark);
    color: var(--text-light);
    padding: 15px 25px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s ease;
    box-shadow: var(--shadow-medium);
    z-index: 1000;
    font-weight: 500;
    min-width: 250px;
    text-align: center;
    transform: translateY(20px);
}
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body>

<div class="container">

  <h1><span class="material-symbols-outlined" style="vertical-align: middle;">event_note</span> Agenda Virtual Milton Borges Ypiranga - Gest칚o</h1>

  <div class="header-info" style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
      <button id="loginBtn"><span class="material-symbols-outlined" style="vertical-align:middle;">account_circle</span> Login Google / Sair</button>
      <span id="userInfo">Aguardando autentica칞칚o...</span>
  </div>

  <div id="dashboard" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
      <div class="panel">
          <h3>칔ltimos Criados</h3>
          <div id="latestEvents">Carregando...</div>
      </div>
      <div class="panel">
          <h3>Pr칩ximos Eventos</h3>
          <div id="upcomingEvents">Carregando...</div>
      </div>
      <div class="panel">
          <h3>Gr치fico Mensal</h3>
          <canvas id="eventsChart"></canvas>
      </div>
  </div>

  <h2>Gerenciar Evento</h2>
  <div class="form-section">
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <input id="title" placeholder="T칤tulo do Evento" style="flex:1;">
          <input type="date" id="date">
      </div>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
          <select id="timeHour"></select> :
          <select id="timeMinute"></select>
          <input id="creator" placeholder="Criador" style="flex:1;">
      </div>
      <textarea id="desc" placeholder="Descri칞칚o" style="width:100%;margin-top:10px;"></textarea>
      <div style="margin-top:15px;display:flex;gap:10px;">
          <button id="save" style="flex:1;">Salvar evento</button>
          <button id="cancelEdit" style="display:none;flex:1;background:var(--danger-color);">Cancelar</button>
      </div>
  </div>

  <h2><span class="material-symbols-outlined" style="vertical-align: middle;">calendar_month</span> Visualizar Eventos no Calend치rio</h2>
  <div id="calendar"></div>

  <br>
  <button id="pdfBtn"><span class="material-symbols-outlined" style="vertical-align:middle;">picture_as_pdf</span> Gerar PDF</button>
</div>

<div id="toast" class="toast"></div>

<script>
// === FIREBASE CONFIG ===
const firebaseConfig = {
  apiKey: "AIzaSyAIdzJHTsvIpUaHszzX8q6jPfR3sh9IfOI",
  authDomain: "agendadigital-44dc9.firebaseapp.com",
  projectId: "agendadigital-44dc9",
  storageBucket: "agendadigital-44dc9.firebasestorage.app",
  messagingSenderId: "569121363405",
  appId: "1:569121363405:web:1c7ab280393c090c40aa72"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginBtn = document.getElementById('loginBtn');
const userInfo = document.getElementById('userInfo');
const toast = document.getElementById('toast');
const saveBtn = document.getElementById('save');
const cancelEditBtn = document.getElementById('cancelEdit');
const titleI = document.getElementById('title');
const dateI = document.getElementById('date');
const timeHourI = document.getElementById('timeHour');
const timeMinuteI = document.getElementById('timeMinute');
const creatorI = document.getElementById('creator');
const descI = document.getElementById('desc');
const latestEventsDiv = document.getElementById('latestEvents');
const upcomingEventsDiv = document.getElementById('upcomingEvents');

let currentUser = null;
let currentEditId = null;
let allEventsCache = [];
let eventsChart = null;
let calendar;

// === TOAST ===
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// === TEMPO ===
function populateTimeSelectors() {
  for (let h=0; h<24; h++) timeHourI.add(new Option(h.toString().padStart(2,'0'), h.toString().padStart(2,'0')));
  for (let m=0; m<60; m+=5) timeMinuteI.add(new Option(m.toString().padStart(2,'0'), m.toString().padStart(2,'0')));
  timeHourI.value = new Date().getHours().toString().padStart(2,'0');
  timeMinuteI.value = '00';
}
populateTimeSelectors();

// === LOGIN ===
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUser=user;
    userInfo.textContent=`Logado como: ${user.displayName||user.email||'Usu치rio'}`;
    loginBtn.innerHTML=`<span class="material-symbols-outlined">logout</span> Sair`;
    creatorI.value = user.displayName||user.email||'';
  }else{
    await auth.signInAnonymously();
    userInfo.textContent='Modo An칪nimo (sem salvar)';
  }
});

loginBtn.onclick = async ()=>{
  if(currentUser && !currentUser.isAnonymous){ await auth.signOut(); showToast("Deslogado!"); return;}
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithPopup(provider);
  showToast("Login Google realizado!");
};

// === CRUD ===
saveBtn.onclick = async ()=>{
  if(!currentUser){ showToast("Fa칞a login!"); return; }
  const title=titleI.value.trim(), date=dateI.value, time=`${timeHourI.value}:${timeMinuteI.value}`, creator=creatorI.value.trim(), desc=descI.value.trim();
  if(!title||!date){ showToast("Preencha t칤tulo e data"); return; }
  const data={title,date,time,creator,desc};
  if(currentEditId){ await db.collection('events').doc(currentEditId).update(data); showToast("Evento atualizado!"); }
  else{ data.createdBy=currentUser.uid; data.createdAt=firebase.firestore.FieldValue.serverTimestamp(); await db.collection('events').add(data); showToast("Evento salvo!"); }
  resetForm();
};

function resetForm(){ titleI.value=''; dateI.value=''; descI.value=''; currentEditId=null; cancelEditBtn.style.display='none'; }
cancelEditBtn.onclick=resetForm;

// === DELETE/EDIT ===
window.editEvent = function(id,e){ currentEditId=id; titleI.value=e.title; dateI.value=e.date; descI.value=e.desc; creatorI.value=e.creator; const [h,m]=(e.time||'00:00').split(':'); timeHourI.value=h; timeMinuteI.value=m; cancelEditBtn.style.display='inline-block'; window.scrollTo({top:0,behavior:'smooth'});}
window.deleteEvent = async function(id){ if(confirm("Excluir evento?")){ await db.collection('events').doc(id).delete(); showToast("Evento exclu칤do!"); }}

// === RENDER LISTA ===
function renderEvents(events,targetDiv){
  targetDiv.innerHTML='';
  if(events.length===0){targetDiv.innerHTML='<p style="color:var(--text-muted);">Nenhum evento.</p>';return;}
  events.forEach(e=>{
    const d=document.createElement('div');
    d.className='event-item';
    d.innerHTML=`<strong>${e.date} ${e.time}</strong>: ${e.title}`;
    targetDiv.appendChild(d);
  });
}

// === GR츼FICO ===
function updateStatsChart(events){
  const ctx=document.getElementById('eventsChart').getContext('2d');
  const counts={}; const now=new Date();
  events.forEach(e=>{
    if(e.createdAt && e.createdAt.toDate){ const d=e.createdAt.toDate(); const k=`${d.getFullYear()}-${d.getMonth()}`; counts[k]=(counts[k]||0)+1;}
  });
  const labels=[], data=[]; for(let i=5;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); const k=`${d.getFullYear()}-${d.getMonth()}`; labels.push(`${d.toLocaleString('pt-BR',{month:'short'})}/${d.getFullYear().toString().slice(-2)}`); data.push(counts[k]||0); }
  if(eventsChart) eventsChart.destroy();
  eventsChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Eventos',data,backgroundColor:['#3f51b5','#00bcd4']}]},options:{plugins:{legend:{display:false}}}});
}

// === CALEND츼RIO ===
function renderCalendar(events){
  const calendarEl=document.getElementById('calendar');
  if(calendar) calendar.destroy();
  const formatted=events.map(e=>({id:e.id,title:e.title,start:`${e.date}T${e.time||'00:00'}`,description:e.desc,creator:e.creator}));
  calendar=new FullCalendar.Calendar(calendarEl,{
    initialView:'dayGridMonth',
    locale:'pt-br',
    headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,timeGridWeek,timeGridDay'},
    events:formatted,
    eventClick:info=>{
      const e=info.event.extendedProps;
      alert(`游늰 ${info.event.title}\n游뎹 ${info.event.start.toLocaleString('pt-BR')}\n游녻 ${e.creator||''}\n游닇 ${e.description||''}`);
    }
  });
  calendar.render();
}

// === SNAPSHOT REALTIME ===
db.collection('events').orderBy('date','asc').orderBy('time','asc')
.onSnapshot(snapshot=>{
  allEventsCache=[];
  snapshot.forEach(doc=>allEventsCache.push({id:doc.id,...doc.data()}));
  const now=new Date();
  const upcoming=allEventsCache.filter(e=>new Date(`${e.date}T${e.time}`)>=now).slice(0,5);
  renderEvents(upcoming,upcomingEventsDiv);
  updateStatsChart(allEventsCache);
  renderCalendar(allEventsCache);
});

// === PDF ===
document.getElementById('pdfBtn').onclick=()=>{
  const {jsPDF}=window.jspdf; const doc=new jsPDF();
  doc.setFontSize(16); doc.text('Agenda Virtual - MBY',10,15);
  const head=[['T칤tulo','Data','Hora','Criador','Descri칞칚o']], rows=allEventsCache.map(e=>[e.title,e.date,e.time,e.creator,e.desc]);
  doc.autoTable({startY:25,head,body:rows}); doc.save('agenda_virtual.pdf');
  showToast("PDF gerado!");
};
</script>
</body>
</html>
