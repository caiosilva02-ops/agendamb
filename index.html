<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Eventos – Nova Versão</title>

    <!-- Google Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #0056b3;
            --background-dark: #2a2a2a;
            --background-light: #f7f7f7;
            --surface-light: #ffffff;
            --surface-dark: #1f1f1f;
            --text-light: #ffffff;
            --text-dark: #333333;
            --border-color: #ccc;
            --accent-red: #e74c3c;
            --accent-green: #27ae60;
        }

        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: var(--background-dark);
            color: var(--text-light);
        }

        .container {
            padding: 20px;
            max-width: 1300px;
            margin: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .form-section {
            background: var(--surface-dark);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        /* ========================= */
        /*         CALENDÁRIO        */
        /* ========================= */

        #calendarContainer {
            padding: 20px;
            background: var(--surface-dark);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
        }

        #calendarHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav-btn {
            padding: 8px 14px;
            background: var(--primary-color);
            border-radius: 6px;
            color: var(--text-light);
            border: none;
            cursor: pointer;
        }
        .calendar-nav-btn:hover {
            background: var(--secondary-color);
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        .calendar-table th {
            background: var(--primary-color);
            color: var(--text-light);
            padding: 10px;
        }

        .calendar-table td {
            height: 90px;
            border: 1px solid var(--border-color);
            vertical-align: top;
            padding: 5px;
            background: var(--surface-light);
            color: var(--text-dark);
            position: relative;
        }

        .calendar-day-number {
            font-weight: bold;
            font-size: 0.9em;
            position: absolute;
            top: 6px;
            left: 6px;
            color: var(--primary-color);
        }

        .calendar-day-has-event {
            background: #eaf3ff !important;
            border: 2px solid var(--primary-color);
        }

        .calendar-event {
            margin-top: 25px;
            font-size: 0.75em;
            background: var(--secondary-color);
            color: white;
            padding: 3px 5px;
            border-radius: 5px;
            display: block;
            text-align: left;
            cursor: pointer;
        }
        .calendar-event:hover {
            background: var(--primary-color);
        }

        /* ========================= */
        /*        MODAL EVENTO       */
        /* ========================= */
        #modalBg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        #modalBox {
            background: var(--surface-light);
            color: var(--text-dark);
            padding: 25px;
            border-radius: 12px;
            width: 400px;
            border: 2px solid var(--primary-color);
        }

        #modalBox h3 {
            margin-top: 0;
        }

        .modal-close {
            background: var(--accent-red);
            color: #fff;
            padding: 8px 12px;
            border: none;
            margin-top: 20px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
        }
        .modal-close:hover {
            background: #c0392b;
        }

        .modal-create-btn {
            background: var(--accent-green);
            color: #fff;
            padding: 8px 12px;
            border: none;
            margin-top: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
        }

    </style>
</head>
<body>
<div class="container">
    <h1><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">event</span> Sistema de Gerenciamento de Eventos</h1>

    <!-- ============================= -->
    <!--     CALENDÁRIO NO TOPO       -->
    <!-- ============================= -->

    <h2><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">calendar_today</span> Calendário de Eventos</h2>

    <div id="calendarContainer" class="form-section">
        <div id="calendarHeader">
            <button id="prevMonth" class="calendar-nav-btn">❮</button>
            <h3 id="calendarMonthYear"></h3>
            <button id="nextMonth" class="calendar-nav-btn">❯</button>
        </div>

        <table id="calendarTable" class="calendar-table">
            <thead>
                <tr>
                    <th>Dom</th><th>Seg</th><th>Ter</th>
                    <th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th>
                </tr>
            </thead>
            <tbody id="calendarBody"></tbody>
        </table>
    </div>

    <!-- MODAL DO EVENTO -->
    <div id="modalBg">
        <div id="modalBox">
            <h3 id="modalTitle"></h3>
            <p id="modalDescription"></p>
            <p><strong>Local:</strong> <span id="modalLocation"></span></p>
            <p><strong>Data:</strong> <span id="modalDate"></span></p>
            <p><strong>Horário:</strong> <span id="modalTime"></span></p>
            <p><strong>Tipo:</strong> <span id="modalType"></span></p>

            <button class="modal-create-btn" id="modalCreateEvent">Criar novo evento nesta data</button>
            <button class="modal-close" id="closeModal">Fechar</button>
        </div>
    </div>

    <!-- ===================================================== -->
    <!--    FORMULÁRIO: CRIAR / EDITAR EVENTOS                 -->
    <!-- ===================================================== -->

    <h2><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">edit_calendar</span> Gerenciar Evento</h2>

    <div class="form-section">
        <form id="eventForm">
            <div class="form-group">
                <label>Título do Evento:</label>
                <input type="text" id="titleInput" required>
            </div>

            <div class="form-group">
                <label>Descrição:</label>
                <textarea id="descriptionInput" rows="4"></textarea>
            </div>

            <div class="form-group">
                <label>Local:</label>
                <input type="text" id="locationInput" required>
            </div>

            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="dateInput" required>
            </div>

            <div class="form-group">
                <label>Horário:</label>
                <input type="time" id="timeInput" required>
            </div>

            <div class="form-group">
                <label>Tipo do Evento:</label>
                <select id="typeInput" required>
                    <option value="Treinamento">Treinamento</option>
                    <option value="Operacional">Operacional</option>
                    <option value="Simulação">Simulação</option>
                    <option value="Reunião">Reunião</option>
                </select>
            </div>

            <input type="hidden" id="eventIdInput">

            <button type="submit" id="submitBtn">Salvar Evento</button>
            <button type="button" id="cancelEditBtn" style="display:none;background:#999;" onclick="cancelEdit()">Cancelar</button>
        </form>
    </div>

    <!-- ===================================================== -->
    <!--   FILTROS + BUSCA DE EVENTOS                          -->
    <!-- ===================================================== -->

    <h2><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">filter_list</span> Filtros</h2>

    <div class="form-section">
        <div class="form-group">
            <label>Filtrar por tipo:</label>
            <select id="filterType">
                <option value="Todos">Todos</option>
                <option value="Treinamento">Treinamento</option>
                <option value="Operacional">Operacional</option>
                <option value="Simulação">Simulação</option>
                <option value="Reunião">Reunião</option>
            </select>
        </div>

        <div class="form-group">
            <label>Buscar por título:</label>
            <input type="text" id="searchInput" placeholder="Digite para buscar...">
        </div>

        <button onclick="applyFilterAndRender()">Aplicar Filtros</button>
        <button onclick="clearFilters()" style="background:#777;">Limpar</button>
    </div>

    <!-- ===================================================== -->
    <!--      SEÇÃO: LISTA DE EVENTOS (ABAIXO DO CALENDÁRIO)  -->
    <!-- ===================================================== -->

    <h2><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">list_alt</span> Todos os Eventos</h2>

    <div id="eventsList" class="form-section"></div>
    <!-- ===================================================== -->
    <!--   DASHBOARD: Estatísticas Rápidas                     -->
    <!-- ===================================================== -->

    <h2><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">monitoring</span> Estatísticas</h2>

    <div class="form-section">
        <div id="statsContainer" style="display:flex;gap:20px;flex-wrap:wrap;">

            <div class="statCard" style="flex:1;min-width:220px;padding:20px;background:var(--surface-light);color:var(--text-dark);border-radius:10px;border:1px solid var(--border-color);">
                <h3>Total de Eventos</h3>
                <p id="totalEvents" style="font-size:1.8em;font-weight:bold;">0</p>
            </div>

            <div class="statCard" style="flex:1;min-width:220px;padding:20px;background:var(--surface-light);color:var(--text-dark);border-radius:10px;border:1px solid var(--border-color);">
                <h3>Próximos 7 dias</h3>
                <p id="next7days" style="font-size:1.8em;font-weight:bold;">0</p>
            </div>

            <div class="statCard" style="flex:1;min-width:220px;padding:20px;background:var(--surface-light);color:var(--text-dark);border-radius:10px;border:1px solid var(--border-color);">
                <h3>Simulações</h3>
                <p id="simCount" style="font-size:1.8em;font-weight:bold;">0</p>
            </div>

            <div class="statCard" style="flex:1;min-width:220px;padding:20px;background:var(--surface-light);color:var(--text-dark);border-radius:10px;border:1px solid var(--border-color);">
                <h3>Treinamentos</h3>
                <p id="treinoCount" style="font-size:1.8em;font-weight:bold;">0</p>
            </div>

        </div>
    </div>

    <!-- ===================================================== -->
    <!--   GRÁFICO DE EVENTOS POR TIPO                         -->
    <!-- ===================================================== -->

    <h2><span class="material-symbols-outlined" style="font-size:1em;vertical-align:middle;">insights</span> Gráfico por Tipos de Eventos</h2>

    <div class="form-section">
        <canvas id="statsChart" height="120"></canvas>
    </div>

    <!-- ===================================================== -->
    <!--   RODAPÉ / SEPARADOR                                  -->
    <!-- ===================================================== -->

    <br><br>
<script type="module">

    /* ========================================================= */
    /* =======================  FIREBASE  ====================== */
    /* ========================================================= */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
        getFirestore, collection, addDoc, updateDoc, deleteDoc,
        doc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD8t0L3-407a0Pn5AEIzVfzH4ErWP0tjyE",
        authDomain: "gcmorg-7e7d6.firebaseapp.com",
        projectId: "gcmorg-7e7d6",
        storageBucket: "gcmorg-7e7d6.appspot.com",
        messagingSenderId: "438722804316",
        appId: "1:438722804316:web:227b45786fae571b5f6ed4",
        measurementId: "G-5CKZL9QEJV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const eventsCollection = collection(db, "calendar_events");

    /* LISTA LOCAL */
    let allEventsCache = [];

    /* ========================================================= */
    /* ===================  CARREGAMENTO AO VIVO  =============== */
    /* ========================================================= */

    onSnapshot(eventsCollection, (snapshot) => {

        allEventsCache = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        applyFilterAndRender();
        updateDashboards(allEventsCache);
        updateStatsChart(allEventsCache);
        renderCalendar(allEventsCache);
    });

    /* ========================================================= */
    /* =======================  CRUD  =========================== */
    /* ========================================================= */

    async function saveEvent(e) {
        e.preventDefault();

        const id = eventIdInput.value;
        const newEvent = {
            title: titleInput.value,
            description: descriptionInput.value,
            location: locationInput.value,
            date: dateInput.value,
            time: timeInput.value,
            type: typeInput.value
        };

        if (id) {
            await updateDoc(doc(db, "calendar_events", id), newEvent);
            submitBtn.textContent = "Salvar Evento";
            cancelEditBtn.style.display = "none";
        } else {
            await addDoc(eventsCollection, newEvent);
        }

        eventForm.reset();
        eventIdInput.value = "";
    }

    eventForm.addEventListener("submit", saveEvent);

    function editEvent(event) {
        titleInput.value = event.title;
        descriptionInput.value = event.description;
        locationInput.value = event.location;
        dateInput.value = event.date;
        timeInput.value = event.time;
        typeInput.value = event.type;
        eventIdInput.value = event.id;

        submitBtn.textContent = "Atualizar Evento";
        cancelEditBtn.style.display = "inline-block";

        window.scrollTo(0, 0);
    }

    async function deleteEvent(id) {
        if (confirm("Tem certeza que deseja excluir este evento?")) {
            await deleteDoc(doc(db, "calendar_events", id));
        }
    }

    function cancelEdit() {
        eventForm.reset();
        eventIdInput.value = "";
        submitBtn.textContent = "Salvar Evento";
        cancelEditBtn.style.display = "none";
    }

    /* ========================================================= */
    /* ===================  RENDERIZA LISTA  ==================== */
    /* ========================================================= */

    function renderEventsList(events) {
        const container = document.getElementById("eventsList");
        container.innerHTML = "";

        if (events.length === 0) {
            container.innerHTML = "<p>Nenhum evento encontrado.</p>";
            return;
        }

        events.sort((a, b) => (a.date > b.date ? 1 : -1));

        events.forEach(ev => {
            const card = document.createElement("div");
            card.style.background = "var(--surface-light)";
            card.style.color = "var(--text-dark)";
            card.style.border = "1px solid var(--border-color)";
            card.style.padding = "15px";
            card.style.marginBottom = "10px";
            card.style.borderRadius = "8px";

            card.innerHTML = `
                <h3>${ev.title}</h3>
                <p><strong>Local:</strong> ${ev.location}</p>
                <p><strong>Data:</strong> ${ev.date}</p>
                <p><strong>Hora:</strong> ${ev.time}</p>
                <p><strong>Tipo:</strong> ${ev.type}</p>
                <button onclick='editEvent(${JSON.stringify(ev)})'>Editar</button>
                <button style="background:#c0392b;" onclick='deleteEvent("${ev.id}")'>Excluir</button>
            `;

            container.appendChild(card);
        });
    }

    /* ========================================================= */
    /* ====================  FILTROS + BUSCA  ================== */
    /* ========================================================= */

    function applyFilterAndRender() {
        let filtered = [...allEventsCache];
        const typeFilter = filterType.value;
        const search = searchInput.value.toLowerCase();

        if (typeFilter !== "Todos") {
            filtered = filtered.filter(ev => ev.type === typeFilter);
        }

        if (search.trim() !== "") {
            filtered = filtered.filter(ev => ev.title.toLowerCase().includes(search));
        }

        renderEventsList(filtered);
    }

    function clearFilters() {
        filterType.value = "Todos";
        searchInput.value = "";
        applyFilterAndRender();
    }

    /* ========================================================= */
    /* ================= DASHBOARD E ESTATÍSTICAS =============== */
    /* ========================================================= */

    function updateDashboards(events) {

        document.getElementById("totalEvents").textContent = events.length;

        let next7 = 0;
        const today = new Date();
        const nextWeek = new Date();
        nextWeek.setDate(today.getDate() + 7);

        events.forEach(ev => {
            const evDate = new Date(ev.date + "T00:00");
            if (evDate >= today && evDate <= nextWeek) next7++;
        });

        document.getElementById("next7days").textContent = next7;

        document.getElementById("simCount").textContent =
            events.filter(e => e.type === "Simulação").length;

        document.getElementById("treinoCount").textContent =
            events.filter(e => e.type === "Treinamento").length;
    }

    /* ========================================================= */
    /* ==============  GRÁFICO — EVENTOS POR TIPO ============== */
    /* ========================================================= */

    let chartInstance = null;

    function updateStatsChart(events) {
        const ctx = document.getElementById("statsChart");

        const counts = {
            Treinamento: 0,
            Operacional: 0,
            Simulação: 0,
            Reunião: 0
        };

        events.forEach(ev => counts[ev.type]++);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    label: "Quantidade",
                    data: Object.values(counts),
                    backgroundColor: [
                        "#3498db", "#9b59b6", "#e67e22", "#2ecc71"
                    ]
                }]
            }
        });
    }

    /* ========================================================= */
    /* =======================  CALENDÁRIO  ==================== */
    /* ========================================================= */

    const calendarContainer = document.getElementById("calendar");
    const monthYearLabel = document.getElementById("monthYear");
    let currentDate = new Date();

    function renderCalendar(events) {
        calendarContainer.innerHTML = "";
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        monthYearLabel.textContent = currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

        const daysOfWeek = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        daysOfWeek.forEach(day => {
            const cell = document.createElement("div");
            cell.textContent = day;
            cell.classList.add("calendar-header");
            calendarContainer.appendChild(cell);
        });

        for (let i = 0; i < firstDay; i++) {
            const emptyCell = document.createElement("div");
            emptyCell.classList.add("calendar-cell", "empty");
            calendarContainer.appendChild(emptyCell);
        }

        for (let day = 1; day <= lastDate; day++) {
            const cell = document.createElement("div");
            cell.classList.add("calendar-cell");
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            cell.textContent = day;

            const dayEvents = events.filter(ev => ev.date === dateStr);
            if (dayEvents.length > 0) {
                const dot = document.createElement("div");
                dot.classList.add("event-dot");
                cell.appendChild(dot);
            }

            cell.addEventListener("click", () => openDayModal(dateStr, dayEvents));
            calendarContainer.appendChild(cell);
        }
    }

    document.getElementById("prevMonth").addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() -1);
        renderCalendar(allEventsCache);
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() +1);
        renderCalendar(allEventsCache);
    });

    /* ========================================================= */
    /* ======================  MODAL  ========================= */
    /* ========================================================= */

    const modal = document.getElementById("dayModal");
    const modalDateLabel = document.getElementById("modalDate");
    const modalEventsList = document.getElementById("modalEvents");
    const addEventDayBtn = document.getElementById("addEventDay");

    function openDayModal(dateStr, events) {
        modal.style.display = "block";
        modalDateLabel.textContent = dateStr;

        modalEventsList.innerHTML = "";
        if (events.length === 0) {
            modalEventsList.innerHTML = "<p>Nenhum evento neste dia.</p>";
        } else {
            events.forEach(ev => {
                const li = document.createElement("li");
                li.textContent = `${ev.time} - ${ev.title} (${ev.type})`;
                li.style.cursor = "pointer";
                li.addEventListener("click", () => editEvent(ev));
                modalEventsList.appendChild(li);
            });
        }

        addEventDayBtn.onclick = () => {
            dateInput.value = dateStr;
            modal.style.display = "none";
            window.scrollTo(0,0);
        };
    }

    document.getElementById("closeModal").addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
    });

    /* ========================================================= */
    /* =======================  INICIALIZA ===================== */
    /* ========================================================= */

    // Render inicial
    applyFilterAndRender();
    renderCalendar(allEventsCache);

</script>
