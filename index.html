<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Acadêmica [Moderna]</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* VARIÁVEIS DE COR (Modo Moderno/Acadêmico) */
:root {
    --primary-color: #3f51b5; /* Azul Institucional (Destaque) */
    --secondary-color: #00bcd4; /* Ciano (Ação/Acento) */
    --background-light: #f4f7f6; /* Fundo principal claro suave */
    --background-dark: #2c3e50; /* Fundo mais escuro para elementos de destaque */
    --surface-light: #ffffff; /* Fundo dos cards/painéis claro */
    --border-color: #e0e0e0;
    --text-dark: #333333;
    --text-light: #ffffff;
    --text-muted: #7f8c8d; /* Texto secundário */
    --shadow-subtle: 0 4px 8px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 8px 16px rgba(0, 0, 0, 0.15);
    --success-color: #28a745; /* Verde para Edição */
    --danger-color: #dc3545; /* Vermelho para Excluir */
}

/* Base e Tipografia */
body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 30px;
    background: var(--background-light);
    color: var(--text-dark);
    transition: background-color 0.5s, color 0.5s;
    line-height: 1.6;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
}
h1 {
    color: var(--primary-color);
    font-weight: 700;
    font-size: 2.5em; /* Aumentado para destaque */
    border-bottom: 3px solid var(--secondary-color); /* Linha de destaque mais robusta */
    padding-bottom: 15px;
    margin-bottom: 30px;
    text-align: center; /* Centralizado para título principal */
}
h2, h3 {
    color: var(--text-dark);
    font-weight: 600;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
    margin-top: 35px;
    margin-bottom: 20px;
}
h2 { color: var(--primary-color); font-size: 1.8em; }
h3 { color: var(--secondary-color); font-size: 1.4em; }


/* Layout e Formulário */
.form-section {
    background: var(--surface-light);
    padding: 25px;
    border-radius: 10px;
    box-shadow: var(--shadow-subtle);
    margin-bottom: 30px;
    border: 1px solid var(--border-color);
}
.input-group {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap; /* Permite quebrar linha em telas menores */
}
input, select, textarea {
    flex-grow: 1;
    padding: 12px 15px;
    font-size: 1em;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--background-light);
    color: var(--text-dark);
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    transition: border-color 0.3s, box-shadow 0.3s;
    margin: 0;
}
input:focus, select:focus, textarea:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2); /* Sombra mais suave */
    background: #ffffff; /* Fundo branco ao focar */
}
input:disabled, select:disabled, textarea:disabled {
    background: #eeeeee;
    cursor: not-allowed;
    color: var(--text-muted);
}
textarea {
    resize: vertical;
    min-height: 100px; /* Altura mínima um pouco maior */
    width: 100%;
    box-sizing: border-box;
    margin-top: 5px;
}

/* Estilo: Grupo de Seletor de Hora com Ícone */
.time-selector-wrapper {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0 10px;
    background: var(--background-light);
    flex-grow: 1;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
.time-selector-icon {
    font-family: 'Material Symbols Outlined'; /* Usando Material Icons */
    font-size: 20px;
    color: var(--primary-color);
    margin-right: 10px;
    font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; /* Estilo padrão */
}
.time-selector-group {
    display: flex;
    gap: 5px;
    flex-grow: 1;
    padding: 8px 0;
}
.time-selector-group select {
    flex-grow: 0;
    width: 70px;
    padding: 8px 5px;
    margin: 0;
    border: none;
    box-shadow: none;
    background: transparent;
    color: var(--text-dark);
}


/* Botões */
button {
    cursor: pointer;
    background: var(--primary-color);
    color: var(--text-light);
    border: none; /* Sem borda para botões primários */
    padding: 12px 25px;
    font-size: 1em;
    font-weight: 500;
    border-radius: 8px;
    transition: background-color 0.3s, box-shadow 0.3s, color 0.3s;
    margin-top: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-subtle);
}
button:hover:not(:disabled) {
    background: var(--secondary-color); /* Efeito hover com a cor secundária */
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
}
button:disabled {
    background: #cccccc;
    color: #999999;
    opacity: 1; /* Não queremos opacidade para não parecer bugado */
    cursor: not-allowed;
    box-shadow: none;
}
#loginBtn {
    background: var(--background-dark); /* Botão de login mais discreto */
    border-color: var(--background-dark);
    color: var(--text-light);
    margin-right: 15px;
}
#loginBtn:hover:not(:disabled) {
    background: var(--primary-color); /* Login hover para o azul principal */
    color: var(--text-light);
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.header-info {
    display: flex;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 20px;
    flex-wrap: wrap; /* Para responsividade */
}
#userInfo {
    font-weight: 400;
    color: var(--text-dark);
    font-size: 0.95em;
    flex-grow: 1; /* Para ocupar o espaço */
}

/* Painéis (Dashboard) */
#dashboard {
    display: grid; /* Usando Grid para melhor controle */
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* 3 colunas, responsivo */
    gap: 20px;
    margin-top: 30px;
    margin-bottom: 40px;
}
.panel {
    background: var(--surface-light);
    padding: 20px;
    border-radius: 10px;
    border-left: 5px solid var(--primary-color); /* Linha institucional */
    box-shadow: var(--shadow-subtle);
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    display: flex; /* Para centralizar o conteúdo verticalmente */
    flex-direction: column;
}
.panel:hover {
    transform: translateY(-5px); /* Efeito sutil ao passar o mouse */
    box-shadow: var(--shadow-medium);
}
.panel h3 {
    color: var(--primary-color);
    border-bottom: 1px solid var(--border-color);
    margin-top: 0;
    padding-bottom: 10px;
    font-size: 1.2em;
}
.event-item {
    padding: 10px 0;
    border-bottom: 1px dashed var(--border-color);
    font-size: 0.9em;
    color: var(--text-dark);
}
.event-item:last-child {
    border-bottom: none;
}
.event-item strong {
    color: var(--background-dark);
    font-weight: 600;
}
/* Estilo do Contêiner do Gráfico */
#stats-chart-container {
    height: 250px; /* Altura um pouco maior para o gráfico */
    padding-top: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Tabelas (Todos os Eventos) */
table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    margin-top: 20px;
    box-shadow: var(--shadow-subtle);
    background: var(--surface-light);
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}
th, td {
    border-bottom: 1px solid var(--border-color);
    padding: 15px 18px;
    text-align: left;
}
th {
    background: var(--background-dark); /* Fundo escuro para cabeçalho */
    font-weight: 600;
    color: var(--text-light); /* Texto branco */
    text-transform: uppercase;
    font-size: 0.9em;
    letter-spacing: 0.5px;
}
tr:nth-child(even) { /* Zebrado para facilitar a leitura */
    background-color: #f9f9f9;
}
tr:hover {
    background-color: #f0f0f0;
}

/* Botões de Ação na Tabela */
.action-btn {
    padding: 8px 15px;
    font-size: 0.85em;
    border-radius: 6px;
    margin-right: 8px;
    margin-top: 0;
    font-weight: 500;
    text-transform: none;
    box-shadow: none; /* Remove sombra dos botões pequenos */
    border: 1px solid transparent; /* Adiciona borda para hover */
}
.action-btn:hover {
    box-shadow: none;
}

.edit-btn {
    background: var(--success-color);
    border-color: var(--success-color);
    color: var(--text-light);
}
.edit-btn:hover {
    background: transparent;
    color: var(--success-color);
    border-color: var(--success-color);
}
.delete-btn {
    background: var(--danger-color);
    border-color: var(--danger-color);
    color: var(--text-light);
}
.delete-btn:hover {
    background: transparent;
    color: var(--danger-color);
    border-color: var(--danger-color);
}
#cancelEdit {
    background: var(--danger-color);
    border-color: var(--danger-color);
    color: var(--text-light);
}
#cancelEdit:hover {
    background: transparent;
    color: var(--danger-color);
    border-color: var(--danger-color);
}
.reset-btn {
    background: var(--text-muted) !important; /* Cor mais neutra */
    border-color: var(--text-muted) !important;
    color: var(--text-light) !important;
}
.reset-btn:hover {
    background: transparent !important;
    color: var(--text-muted) !important;
    border-color: var(--text-muted) !important;
    box-shadow: none !important;
}


/* Estilos do Toast */
.toast {
    position: fixed; right: 20px; bottom: 20px;
    background: var(--background-dark); /* Fundo escuro para o toast */
    color: var(--text-light);
    padding: 15px 25px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s ease;
    box-shadow: var(--shadow-medium);
    z-index: 1000;
    font-weight: 500;
    min-width: 250px;
    text-align: center;
    transform: translateY(20px);
}
.toast.show {
    opacity: 1;
    transform: translateY(0);
}

/* Responsividade Básica */
@media (max-width: 768px) {
    body { padding: 15px; }
    .input-group { flex-direction: column; gap: 10px; }
    .time-selector-wrapper { padding: 0 5px; }
    .time-selector-icon { margin-right: 5px; }
    .time-selector-group select { width: 60px; padding: 6px 3px; }
    button { padding: 10px 15px; font-size: 0.9em; }
    #dashboard { grid-template-columns: 1fr; }
    .header-info { flex-direction: column; align-items: flex-start; gap: 10px; }
    #loginBtn { margin-right: 0; width: 100%; }
    #userInfo { text-align: center; width: 100%; margin-top: 10px; }
    table, thead, tbody, th, td, tr {
        display: block;
    }
    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    tr { border: 1px solid var(--border-color); margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
    td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 50%;
        text-align: right;
    }
    td:before {
        position: absolute;
        top: 0;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: 600;
        color: var(--primary-color);
        font-size: 0.9em;
    }
    td:nth-of-type(1):before { content: "Título"; }
    td:nth-of-type(2):before { content: "Data"; }
    td:nth-of-type(3):before { content: "Hora"; }
    td:nth-of-type(4):before { content: "Criador"; }
    td:nth-of-type(5):before { content: "Descrição"; }
    td:nth-of-type(6):before { content: "Ações"; }
    td:last-child {
        text-align: center;
        padding-left: 6px; /* Ajuste para centralizar botões */
    }
    .action-btn { width: auto; display: inline-block; margin-bottom: 5px; }
}

</style>
</head>
<body>

<div class="container">

    <h1><span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.2em;">event_note</span> Agenda Acadêmica</h1>

    <div class="header-info">
      <button id="loginBtn"><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">account_circle</span> Login Google / Sair</button>
      <span id="userInfo">Aguardando autenticação...</span>
    </div>

    <div id="dashboard">
        <div class="panel">
            <h3><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">history</span> Últimos Criados</h3>
            <div id="latestEvents">Carregando...</div>
        </div>
        <div class="panel">
            <h3><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">event_upcoming</span> Próximos Eventos</h3>
            <div id="upcomingEvents">Carregando...</div>
        </div>
        <div class="panel">
            <h3><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">insights</span> Gráfico Mensal</h3>
            <div id="stats-chart-container">
                <canvas id="eventsChart"></canvas>
            </div>
        </div>
    </div>

    <h2><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">edit_calendar</span> Gerenciar Evento</h2>
    <div class="form-section">
        <div class="input-group">
            <input id="title" placeholder="Título do Evento" />
            <input type="date" id="date" />
        </div>

        <div class="input-group">
            <div class="time-selector-wrapper">
                <span class="material-symbols-outlined time-selector-icon">schedule</span>
                <div class="time-selector-group">
                    <select id="timeHour"></select> :
                    <select id="timeMinute"></select>
                </div>
            </div>

            <input id="creator" placeholder="Nome do Criador" />
        </div>

        <textarea id="desc" placeholder="Descrição detalhada do evento"></textarea>

        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button id="save" style="flex-grow: 1;"><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">save</span> Salvar evento</button>
            <button id="cancelEdit" style="display:none; flex-grow: 1;" class="danger-btn"><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">cancel</span> Cancelar Edição</button>
        </div>
    </div>

    <h2><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">view_list</span> Todos os Eventos</h2>

    <div class="form-section" style="margin-bottom: 15px; padding: 15px 20px;">
        <h3>Filtro por Intervalo de Data</h3>
        <div class="input-group" style="margin-bottom: 0;">
            <input type="date" id="filterDateStart" style="flex-grow: 1;" placeholder="Data Inicial"/>
            <input type="date" id="filterDateEnd" style="flex-grow: 1;" placeholder="Data Final"/>
            <button id="applyFilterBtn" style="flex-grow: 0; min-width: 150px; margin-top: 0; font-weight: 500; text-transform: none;">
                <span id="filterIcon" class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">search</span> Aplicar Filtro
            </button>
            <button id="resetFilterBtn" class="reset-btn" style="flex-grow: 0; min-width: 150px; margin-top: 0; font-weight: 500; text-transform: none;">
                <span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">filter_alt_off</span> Limpar Filtro
            </button>
        </div>
    </div>

    <table>
      <thead>
        <tr><th>Título</th><th>Data</th><th>Hora</th><th>Criador</th><th>Descrição</th><th>Ações</th></tr>
      </thead>
      <tbody id="eventsBody"><tr><td colspan="6">Carregando eventos...</td></tr></tbody>
    </table>

    <br>
    <button id="pdfBtn" style="margin-bottom: 50px;"><span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">picture_as_pdf</span> Gerar PDF</button>

</div>

<div id="toast" class="toast"></div>

<script>
// NOTA: Mantenha suas credenciais privadas.
const firebaseConfig = {
  apiKey: "AIzaSyAIdzJHTsvIpUaHszzX8q6jPfR3sh9IfOI",
  authDomain: "agendadigital-44dc9.firebaseapp.com",
  projectId: "agendadigital-44dc9",
  storageBucket: "agendadigital-44dc9.firebasestorage.app",
  messagingSenderId: "569121363405",
  appId: "1:569121363405:web:1c7ab280393c090c40aa72"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elementos DOM
const loginBtn = document.getElementById('loginBtn');
const userInfo = document.getElementById('userInfo');
const toast = document.getElementById('toast');
const tbody = document.getElementById('eventsBody');
const titleI = document.getElementById('title');
const dateI = document.getElementById('date');
const timeHourI = document.getElementById('timeHour');
const timeMinuteI = document.getElementById('timeMinute');
const creatorI = document.getElementById('creator');
const descI = document.getElementById('desc');
const saveBtn = document.getElementById('save');
const cancelEditBtn = document.getElementById('cancelEdit');
const latestEventsDiv = document.getElementById('latestEvents');
const upcomingEventsDiv = document.getElementById('upcomingEvents');

// NOVOS ELEMENTOS DO FILTRO
const filterDateStartI = document.getElementById('filterDateStart');
const filterDateEndI = document.getElementById('filterDateEnd');
const applyFilterBtn = document.getElementById('applyFilterBtn');
const resetFilterBtn = document.getElementById('resetFilterBtn');
const filterIcon = document.getElementById('filterIcon');

let currentUser = null;
let currentEditId = null;
let allEventsCache = []; // Cache para armazenar todos os eventos brutos
let eventsChart = null; // Variável para o objeto do gráfico


function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// 🔹 Inicialização do Seletor de Horas/Minutos
function populateTimeSelectors() {
    for (let h = 0; h < 24; h++) {
        const hour = h.toString().padStart(2, '0');
        const option = new Option(hour, hour);
        timeHourI.appendChild(option);
    }
    for (let m = 0; m < 60; m += 5) { // Incremento de 5 minutos
        const minute = m.toString().padStart(2, '0');
        const option = new Option(minute, minute);
        timeMinuteI.appendChild(option);
    }
    timeHourI.value = new Date().getHours().toString().padStart(2, '0');
    timeMinuteI.value = '00';
}
populateTimeSelectors();


// 🔹 Mantém login persistente
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

/**
 * 🔹 Habilita ou desabilita os campos do formulário de evento (Aprimorado)
 * @param {boolean} enabled - true para habilitar, false para desabilitar
 */
function toggleForm(enabled) {
    const inputs = [titleI, dateI, timeHourI, timeMinuteI, creatorI, descI];
    inputs.forEach(input => {
        if (!enabled) {
            input.setAttribute('disabled', 'disabled');
        } else {
            input.removeAttribute('disabled');
        }
    });

    if (!enabled) {
        saveBtn.setAttribute('disabled', 'disabled');
        saveBtn.textContent = 'FAÇA LOGIN PARA SALVAR';
        cancelEditBtn.style.display = 'none';
    } else {
        saveBtn.removeAttribute('disabled');
        saveBtn.textContent = currentEditId ? 'Atualizar evento' : 'Salvar evento';
    }
}

// 🔹 Detecta mudanças de autenticação (Com correção de UX)
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        const name = user.isAnonymous ? 'Anônimo' : (user.displayName || user.email);
        userInfo.textContent = `Logado como: ${name}`;
        loginBtn.innerHTML = `<span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">${user.isAnonymous ? 'account_circle' : 'logout'}</span> ${user.isAnonymous ? 'Login Google' : 'Sair'}`;
        
        if (!creatorI.value) {
            creatorI.value = name;
        }

        toggleForm(true); // Habilita o formulário
    } else {
        // Se não há usuário, tenta login anônimo (com o método original)
        try {
            await auth.signInAnonymously();
        } catch (err) {
            // Em caso de erro, define o usuário como nulo e desabilita o formulário
            currentUser = null;
            userInfo.textContent = `Aguardando autenticação (Login obrigatório para salvar).`;
            loginBtn.innerHTML = `<span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">account_circle</span> Login Google / Anônimo`;
            creatorI.value = ''; 
            toggleForm(false);
        }
    }
});


// 🔹 Botão de login / logout (Usando Pop-up)
loginBtn.addEventListener('click', async () => {
  if (currentUser && !currentUser.isAnonymous) {
    // Se o usuário está logado via Google, faz logout
    await auth.signOut();
    showToast("Deslogado com sucesso");
  } else {
    // Se está anônimo ou deslogado, oferece login Google
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');
    try {
      await auth.signInWithPopup(provider);
      showToast("Login Google realizado com sucesso!");
    } catch (e) {
      console.error(e);
      if (e.code !== 'auth/popup-closed-by-user') {
        showToast("Erro no login Google");
      }
      // Se o pop-up foi fechado ou falhou, o onAuthStateChanged irá gerenciar o estado anônimo
    }
  }
});


/**
 * 🔹 Limpa o formulário e retorna ao modo de criação
 */
function resetForm() {
    titleI.value = '';
    dateI.value = '';
    descI.value = '';
    timeHourI.value = new Date().getHours().toString().padStart(2, '0');
    timeMinuteI.value = '00';

    currentEditId = null;
    saveBtn.textContent = 'Salvar evento';
    saveBtn.style.backgroundColor = 'var(--primary-color)';
    saveBtn.style.borderColor = 'var(--primary-color)';
    saveBtn.style.color = 'var(--text-light)';
    cancelEditBtn.style.display = 'none';

    if (currentUser && !currentUser.isAnonymous) {
        creatorI.value = currentUser.displayName || currentUser.email || '';
    } else {
        creatorI.value = ''; 
    }
}
cancelEditBtn.addEventListener('click', resetForm);


/**
 * 🔹 Pré-preenche o formulário para edição
 * @param {string} id - O ID do documento no Firestore
 * @param {object} eventData - Os dados do evento
 */
function editEvent(id, eventData) {
    if (!currentUser) { // Impede edição se não estiver logado
        showToast("Faça login para editar eventos.");
        return;
    }
    currentEditId = id;

    titleI.value = eventData.title || '';
    dateI.value = eventData.date || '';
    creatorI.value = eventData.creator || '';
    descI.value = eventData.desc || '';

    const [hour, minute] = (eventData.time || '00:00').split(':');
    timeHourI.value = hour.padStart(2, '0');
    timeMinuteI.value = minute.padStart(2, '0');

    saveBtn.textContent = 'Atualizar evento';
    saveBtn.style.backgroundColor = 'var(--success-color)';
    saveBtn.style.borderColor = 'var(--success-color)';
    saveBtn.style.color = 'var(--text-light)';
    cancelEditBtn.style.display = 'inline-block';

    window.scrollTo({ top: 0, behavior: 'smooth' });
}
window.editEvent = editEvent;


/**
 * 🔹 Função para deletar um evento
 * @param {string} id - O ID do documento no Firestore
 */
async function deleteEvent(id) {
    if (!currentUser) { // Impede deleção se não estiver logado
        showToast("Faça login para excluir eventos.");
        return;
    }
    if (!confirm("Tem certeza que deseja excluir este evento?")) {
        return;
    }
    try {
        await db.collection('events').doc(id).delete();
        showToast("Evento excluído!");
        if (currentEditId === id) {
            resetForm();
        }
    } catch (err) {
        console.error("Erro ao excluir evento:", err);
        showToast("Erro ao excluir evento");
    }
}
window.deleteEvent = deleteEvent;


// 🔹 Salvar/Atualizar evento
saveBtn.addEventListener('click', async () => {
  if (!currentUser) {
    showToast("Você precisa estar logado para salvar eventos.");
    return;
  }

  const title = titleI.value.trim();
  const date = dateI.value;
  const time = `${timeHourI.value}:${timeMinuteI.value}`;
  const creator = creatorI.value.trim();
  const desc = descI.value.trim();

  if (!title || !date) {
    showToast("Título e data são obrigatórios");
    return;
  }

  saveBtn.disabled = true;

  try {
    const eventData = {
        title, date, time, creator, desc,
    };

    if (currentEditId) {
        // MODO DE EDIÇÃO
        await db.collection('events').doc(currentEditId).update(eventData);
        showToast("Evento atualizado!");
    } else {
        // MODO DE CRIAÇÃO
        eventData.createdBy = currentUser ? currentUser.uid : null;
        eventData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('events').add(eventData);
        showToast("Evento salvo!");
    }

    resetForm();

  } catch (err) {
    console.error(err);
    showToast(`Erro ao ${currentEditId ? 'atualizar' : 'salvar'} evento`);
  } finally {
    saveBtn.disabled = false;
  }
});

/**
 * 🔹 Renderiza a lista de eventos no painel (todos, próximos, ou recentes)
 * @param {Array} events - A lista de eventos a ser renderizada.
 * @param {string} type - Tipo de renderização ('table' ou 'list').
 * @param {HTMLElement} targetDiv - O elemento DOM alvo (usado apenas para type='list').
 */
function renderEvents(events, type = 'table', targetDiv = null) {
    if (type === 'table') {
        tbody.innerHTML = '';
        if (events.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="color: var(--text-muted); text-align: center; padding: 20px;">Nenhum evento encontrado no período.</td></tr>';
            return;
        }
        events.forEach(e => {
            const tr = document.createElement('tr');
            // Escapando o JSON antes de usar em onclick
            const eventDataString = JSON.stringify({
                title: e.title,
                date: e.date,
                time: e.time,
                creator: e.creator,
                desc: e.desc
            }).replace(/"/g, "'");

            tr.innerHTML = `
                <td>${e.title || ''}</td>
                <td>${e.date || ''}</td>
                <td>${e.time || ''}</td>
                <td>${e.creator || ''}</td>
                <td>${e.desc || ''}</td>
                <td>
                    <button class="action-btn edit-btn"
                                onclick="editEvent('${e.id}', ${eventDataString})">
                                <span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">edit</span> Editar
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteEvent('${e.id}')">
                                <span class="material-symbols-outlined" style="font-size: 1em; vertical-align: middle;">delete</span> Excluir
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } else if (type === 'list' && targetDiv) {
        targetDiv.innerHTML = '';
        if (events.length === 0) {
             targetDiv.innerHTML = '<p style="margin: 0; font-size:0.85em; color: var(--text-muted);">Nenhum evento encontrado.</p>';
             return;
        }
        events.forEach(e => {
            const div = document.createElement('div');
            div.className = 'event-item';
            div.innerHTML = `
                <strong>${e.date} ${e.time}</strong>: ${e.title} <span style="color: var(--text-muted);">(Criador: ${e.creator})</span>
            `;
            targetDiv.appendChild(div);
        });
    }
}


/**
 * 🔹 Filtra os eventos do cache pelo período selecionado.
 * @param {Array} events - Lista de eventos a serem filtrados.
 * @param {string} start - Data de início (YYYY-MM-DD).
 * @param {string} end - Data final (YYYY-MM-DD).
 * @returns {Array} Eventos filtrados.
 */
function filterEventsByDate(events, start, end) {
    if (!start && !end) return events;

    const startDate = start ? new Date(start + 'T00:00:00') : null; // Início do dia
    const endDate = end ? new Date(end + 'T23:59:59') : null; // Fim do dia

    return events.filter(e => {
        // Tenta criar a data e hora. Se o tempo for 00:00, apenas a data é usada.
        const eventDateTimeString = e.date + (e.time ? `T${e.time}` : 'T00:00:00');
        const eventDate = new Date(eventDateTimeString);

        let isAfterStart = true;
        let isBeforeEnd = true;

        if (startDate) {
            isAfterStart = eventDate >= startDate;
        }

        if (endDate) {
            isBeforeEnd = eventDate <= endDate;
        }

        return isAfterStart && isBeforeEnd;
    }).sort((a, b) => {
        // Garante a ordenação correta após a filtragem
        if (a.date < b.date) return -1;
        if (a.date > b.date) return 1;
        if (a.time < b.time) return -1;
        if (a.time > b.time) return 1;
        return 0;
    });
}

/**
 * 🔹 Aplica o filtro de data e renderiza a tabela principal.
 */
function applyFilterAndRender() {
    const start = filterDateStartI.value;
    const end = filterDateEndI.value;

    // Altera ícone para indicar filtragem ativa
    if (start || end) {
        filterIcon.textContent = 'check_circle'; // Ícone de "checado"
    } else {
        filterIcon.textContent = 'search'; // Ícone de "buscar"
    }

    const filteredEvents = filterEventsByDate(allEventsCache, start, end);
    renderEvents(filteredEvents, 'table');
}

// Listeners para o filtro
applyFilterBtn.addEventListener('click', applyFilterAndRender);
resetFilterBtn.addEventListener('click', () => {
    filterDateStartI.value = '';
    filterDateEndI.value = '';
    applyFilterAndRender();
});


// 🔹 Listener em tempo real para todos os eventos
db.collection('events')
  .orderBy('date','asc')
  .orderBy('time','asc')
  .onSnapshot(snapshot => {
    allEventsCache = []; // Limpa o cache
    if (!snapshot.empty) {
        snapshot.forEach(doc => {
            const data = doc.data();
            // Garante que o evento tem a data de criação para stats
            if (data.createdAt && data.createdAt.toDate) {
                data.createdAtDate = data.createdAt.toDate();
            } else {
                data.createdAtDate = null;
            }
            allEventsCache.push({ id: doc.id, ...data });
        });
    }

    applyFilterAndRender(); // Renderiza a tabela aplicando o filtro (inicialmente vazio)
    updateDashboards(allEventsCache);
    updateStatsChart(allEventsCache); // Atualiza o gráfico

  }, error => {
    console.error("Erro ao receber eventos:", error);
    showToast("Erro ao carregar a lista de eventos.");
  });

/**
 * 🔹 Atualiza os painéis "Próximos Eventos" e "Últimos Criados"
 * @param {Array} allEvents - Lista completa de eventos.
 */
function updateDashboards(allEvents) {
    const now = new Date();

    const upcomingEvents = allEvents
        .filter(e => {
            const eventDateTime = new Date(`${e.date}T${e.time}`);
            return eventDateTime >= now;
        })
        .slice(0, 5); // Limita aos 5 próximos

    renderEvents(upcomingEvents, 'list', upcomingEventsDiv);

    // Para "Últimos Criados", faz uma nova consulta para garantir a ordenação por createdAt
    db.collection('events')
        .orderBy('createdAt', 'desc')
        .limit(5)
        .get()
        .then(snapshot => {
            let latest = [];
            snapshot.forEach(doc => {
                latest.push({ id: doc.id, ...doc.data() });
            });
            renderEvents(latest, 'list', latestEventsDiv);
        })
        .catch(err => {
            console.error("Erro ao carregar eventos recentes:", err);
            latestEventsDiv.innerHTML = 'Erro ao carregar recentes.';
        });
}

/**
 * 🔹 Gera os dados e desenha o gráfico de estatísticas mensais.
 * @param {Array} events - Lista completa de eventos.
 */
function updateStatsChart(events) {
    // Mapeamento de eventos por mês de criação
    const monthlyCounts = {};
    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

    const now = new Date();

    events.forEach(e => {
        if (e.createdAtDate) {
            const date = e.createdAtDate;
            const yearMonth = `${date.getFullYear()}-${date.getMonth()}`;
            monthlyCounts[yearMonth] = (monthlyCounts[yearMonth] || 0) + 1;
        }
    });

    // Gera os rótulos (últimos 6 meses)
    const labels = [];
    const data = [];
    for (let i = 5; i >= 0; i--) { // 6 meses, contando com o mês atual (0)
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const yearMonthKey = `${date.getFullYear()}-${date.getMonth()}`;
        labels.push(`${monthNames[date.getMonth()]}/${date.getFullYear().toString().slice(-2)}`);
        data.push(monthlyCounts[yearMonthKey] || 0);
    }

    // Destrói o gráfico anterior se existir
    if (eventsChart) {
        eventsChart.destroy();
    }

    const ctx = document.getElementById('eventsChart').getContext('2d');
    eventsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Eventos Criados',
                data: data,
                // Cores acadêmicas: Azul e Ciano (primária e secundária)
                backgroundColor: [
                    'rgba(63, 81, 181, 0.8)', // primary-color
                    'rgba(0, 188, 212, 0.8)', // secondary-color
                    'rgba(63, 81, 181, 0.8)',
                    'rgba(0, 188, 212, 0.8)',
                    'rgba(63, 81, 181, 0.8)',
                    'rgba(0, 188, 212, 0.8)'
                ],
                borderColor: [
                    '#3f51b5',
                    '#00bcd4',
                    '#3f51b5',
                    '#00bcd4',
                    '#3f51b5',
                    '#00bcd4'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'var(--text-dark)', // Cor do texto
                        precision: 0
                    },
                    grid: {
                        color: 'var(--border-color)' // Linhas de grade suaves
                    }
                },
                x: {
                    ticks: {
                        color: 'var(--text-dark)' // Cor do texto
                    },
                    grid: {
                        color: 'var(--border-color)' // Linhas de grade suaves
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Criações nos Últimos 6 Meses',
                    color: 'var(--primary-color)', // Título em cor principal
                    font: {
                        family: 'Inter, sans-serif',
                        size: 14,
                        weight: '600'
                    }
                }
            }
        }
    });
}


// 🔹 Gerar PDF com os eventos VISÍVEIS na tabela (respeitando o filtro de data)
document.getElementById('pdfBtn').addEventListener('click', () => {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const head = [['Título', 'Data', 'Hora', 'Criador', 'Descrição']];
        const rows = [];

        // Seleciona as linhas atualmente visíveis na tabela
        const eventRows = document.querySelectorAll('#eventsBody tr');

        eventRows.forEach(row => {
            // Se a linha não for a de "Nenhum evento encontrado"
            if (row.children.length === 6) {
                const cells = row.querySelectorAll('td');
                rows.push([
                    cells[0].textContent,
                    cells[1].textContent,
                    cells[2].textContent,
                    cells[3].textContent,
                    cells[4].textContent
                ]);
            }
        });

        if (rows.length === 0) {
            showToast("Nenhum evento na tabela para gerar PDF");
            return;
        }

        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text('Agenda Acadêmica', 10, 15);

        // Adiciona a informação do filtro no PDF, se estiver ativo
        const start = filterDateStartI.value;
        const end = filterDateEndI.value;
        let finalY = 25;
        if (start || end) {
            let filterText = 'Filtro Aplicado: ';
            if (start) filterText += `De ${new Date(start).toLocaleDateString()} `;
            if (end) filterText += `Até ${new Date(end).toLocaleDateString()}`;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(filterText, 10, 22);
            finalY = 28;
        }


        doc.autoTable({
            startY: finalY,
            head: head,
            body: rows,
            theme: 'striped', // Tema listrado, mais acadêmico
            headStyles: {
                fillColor: [44, 62, 80], // background-dark
                textColor: [255, 255, 255], // text-light
                font: 'helvetica',
                fontStyle: 'bold'
            },
            bodyStyles: {
                textColor: [51, 51, 51], // text-dark
                fillColor: [255, 255, 255], // surface-light
                font: 'helvetica'
            },
            alternateRowStyles: {
                fillColor: [244, 247, 246] // background-light
            },
            styles: { fontSize: 10, cellPadding: 3 },
            columnStyles: {
                0: { cellWidth: 35 },
                1: { cellWidth: 20 },
                2: { cellWidth: 15 },
                3: { cellWidth: 25 },
                4: { cellWidth: 'auto' }
            }
        });


        doc.save('agenda_academica.pdf');
        showToast("PDF gerado!");
    } catch (err) {
        console.error("Erro ao gerar PDF:", err);
        showToast("Erro ao gerar PDF");
    }
});
</script>
</body>
</html>
