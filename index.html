<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agenda Firebase Aprimorada</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: 'Inter', sans-serif; margin: 20px; background:#f5f6fb; color:#222; }
h1 { color:#333; }
input, textarea, button { margin: 4px 0; padding: 8px 10px; font-size:14px; border-radius: 4px; border: 1px solid #ddd; }
button { cursor:pointer; background: #007bff; color: white; border: none; font-weight: bold; }
button:hover:not(:disabled) { background: #0056b3; }
button:disabled { background: #ccc; cursor: not-allowed; }
table { border-collapse: collapse; width: 100%; margin-top:10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background: white; }
th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
th { background: #f0f0f0; }
.delete-btn { background: #dc3545; padding: 4px 8px; font-size: 12px; }
.delete-btn:hover { background: #c82333; }

/* Estilos do Toast */
.toast {
  position: fixed; right: 15px; bottom: 15px;
  background: #333; color: #fff; padding: 10px 14px;
  border-radius: 8px; opacity: 0; transition: opacity 0.3s ease;
  z-index: 1000;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>

<h1>📅 Agenda de Eventos</h1>

<div>
  <button id="loginBtn">Login Google / Sair</button>
  <span id="userInfo">Carregando...</span>
</div>

<h2>Novo Evento</h2>
<input id="title" placeholder="Título" /><br>
<input type="date" id="date" /><br>
<input type="time" id="time" /><br>
<input id="creator" placeholder="Criador" /><br>
<textarea id="desc" placeholder="Descrição"></textarea><br>
<button id="save">Salvar evento</button>

<h2>Eventos</h2>
<table>
  <thead>
    <tr><th>Título</th><th>Data</th><th>Hora</th><th>Criador</th><th>Descrição</th><th>Ações</th></tr>
  </thead>
  <tbody id="eventsBody"><tr><td colspan="6">Carregando eventos...</td></tr></tbody>
</table>

<br>
<button id="pdfBtn">📄 Gerar PDF</button>

<div id="toast" class="toast"></div>

<script>
// NOTA: Esta API Key é apenas para fins de demonstração no navegador.
// Em produção, use Variáveis de Ambiente ou restrições de API Key rigorosas.
const firebaseConfig = {
  apiKey: "AIzaSyAIdzJHTsvIpUaHszzX8q6jPfR3sh9IfOI",
  authDomain: "agendadigital-44dc9.firebaseapp.com",
  projectId: "agendadigital-44dc9",
  storageBucket: "agendadigital-44dc9.firebasestorage.app",
  messagingSenderId: "569121363405",
  appId: "1:569121363405:web:1c7ab280393c090c40a084"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elementos DOM
const loginBtn = document.getElementById('loginBtn');
const userInfo = document.getElementById('userInfo');
const toast = document.getElementById('toast');
const tbody = document.getElementById('eventsBody');
const titleI = document.getElementById('title');
const dateI = document.getElementById('date');
const timeI = document.getElementById('time');
const creatorI = document.getElementById('creator');
const descI = document.getElementById('desc');
const saveBtn = document.getElementById('save'); // Pegando o botão para desabilitar

let currentUser = null;

function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// 🔹 Mantém login persistente
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

// 🔹 Detecta mudanças de autenticação
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    const name = user.isAnonymous ? 'Usuário anônimo' : (user.displayName || user.email);
    userInfo.textContent = `Logado como: ${name}`;
    loginBtn.textContent = user.isAnonymous ? 'Login Google' : 'Sair';
    if (!creatorI.value) creatorI.value = name;
  } else {
    try {
      // Tenta logar anonimamente se não houver usuário logado
      await auth.signInAnonymously();
    } catch (err) {
      console.error(err);
      showToast("Erro ao autenticar anonimamente");
    }
  }
});

// 🔹 Botão de login / logout
// 🔹 Botão de login / logout
loginBtn.addEventListener('click', async () => {
  if (currentUser && !currentUser.isAnonymous) {
    await auth.signOut();
    showToast("Deslogado com sucesso");
  } else {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.addScope('profile');
    provider.addScope('email');
    try {
      // ❗ ALTERAÇÃO AQUI: De 'signInWithRedirect' para 'signInWithPopup'
      await auth.signInWithPopup(provider); 
      // O 'auth.onAuthStateChanged' será disparado automaticamente após o pop-up ser fechado
      showToast("Login Google realizado com sucesso!");
    } catch (e) {
      console.error(e);
      // Se o usuário fechar o pop-up, o código é 'auth/popup-closed-by-user', que não é um erro real.
      if (e.code !== 'auth/popup-closed-by-user') {
        showToast("Erro no login Google: " + e.message);
      }
    }
  }
});

/**
 * 🔹 Função para deletar um evento
 * @param {string} id - O ID do documento no Firestore
 */
async function deleteEvent(id) {
    if (!confirm("Tem certeza que deseja excluir este evento?")) {
        return;
    }
    try {
        await db.collection('events').doc(id).delete();
        showToast("Evento excluído!");
    } catch (err) {
        console.error("Erro ao excluir evento:", err);
        showToast("Erro ao excluir evento");
    }
}
// Torna a função acessível no escopo global para o 'onclick'
window.deleteEvent = deleteEvent; 


// 🔹 Salvar evento
saveBtn.addEventListener('click', async () => {
  const title = titleI.value.trim();
  const date = dateI.value;
  const time = timeI.value;
  const creator = creatorI.value.trim();
  const desc = descI.value.trim();

  if (!title || !date) {
    showToast("Título e data são obrigatórios");
    return;
  }
  
  saveBtn.disabled = true; // Desabilita o botão

  try {
    await db.collection('events').add({
      title, date, time, creator, desc,
      createdBy: currentUser ? currentUser.uid : null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showToast("Evento salvo!");
    
    // Limpeza completa do formulário (Melhoria UX)
    titleI.value = '';
    dateI.value = ''; 
    timeI.value = '';
    descI.value = '';

  } catch (err) {
    console.error(err);
    showToast("Erro ao salvar evento");
  } finally {
    saveBtn.disabled = false; // Habilita o botão
  }
});

// 🔹 Listener em tempo real para eventos
db.collection('events')
  // Ordenação corrigida: 'asc' para mostrar eventos próximos primeiro (do mais antigo para o mais novo)
  .orderBy('date','asc') 
  .orderBy('time','asc')
  .onSnapshot(snapshot => {
    tbody.innerHTML = '';
    if (snapshot.empty) {
      tbody.innerHTML = '<tr><td colspan="6">Nenhum evento</td></tr>'; // Colspan ajustado para 6
      return;
    }
    snapshot.forEach(doc => {
      const e = doc.data();
      const tr = document.createElement('tr');
      // Inclui o ID do documento e o botão Excluir na última coluna
      tr.innerHTML = `
        <td>${e.title || ''}</td>
        <td>${e.date || ''}</td>
        <td>${e.time || ''}</td>
        <td>${e.creator || ''}</td>
        <td>${e.desc || ''}</td>
        <td>
            <button class="delete-btn" onclick="deleteEvent('${doc.id}')">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }, error => {
    console.error("Erro ao receber eventos:", error);
    showToast("Erro ao carregar a lista de eventos.");
  });

// 🔹 Gerar PDF com todos os eventos
document.getElementById('pdfBtn').addEventListener('click', () => {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    doc.setFontSize(16);
    doc.text('Agenda de Eventos', 10, y);
    y += 10;
    doc.setFontSize(12);

    // Seleciona todas as linhas da tabela exceto a que indica 'Nenhum evento'
    const rows = document.querySelectorAll('#eventsBody tr');
    
    // Filtra linhas que não são a mensagem de 'Nenhum evento'
    const eventRows = Array.from(rows).filter(row => row.children.length === 6); 

    if (eventRows.length === 0) {
      showToast("Nenhum evento para gerar PDF");
      return;
    }

    eventRows.forEach(row => {
      // Pega as primeiras 5 células (Título, Data, Hora, Criador, Descrição)
      const cells = row.querySelectorAll('td'); 
      if (cells.length < 5) return; 
      
      doc.text(`Título: ${cells[0].textContent}`, 10, y); y += 6;
      doc.text(`Data: ${cells[1].textContent} Hora: ${cells[2].textContent}`, 10, y); y += 6;
      doc.text(`Criador: ${cells[3].textContent}`, 10, y); y += 6;
      doc.text(`Descrição: ${cells[4].textContent}`, 10, y); y += 8;
      
      if (y > 270) { doc.addPage(); y = 10; } // Quebra de página
    });

    doc.save('agenda.pdf');
    showToast("PDF gerado!");
  } catch (err) {
    console.error("Erro ao gerar PDF:", err);
    showToast("Erro ao gerar PDF");
  }
});

</script>
</body>
</html>

